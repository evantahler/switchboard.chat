#!/usr/bin/ruby
# managed by ansible

USERNAME     = "root"
PASSWORD     = nil
BIN          = "/usr/bin/innobackupex"
XTRABACKUP   = "/usr/bin/xtrabackup"
CONF         = "/etc/mysql/my.cnf"
DESTINATION  = "/opt/mysql_backups"
MEMORY       = "100M"
BACKUP_COUNT = 5

def list_dirs(d)
  dirs = Dir.entries(d).select {|entry| File.directory? File.join(d, entry) and !(entry =='.' || entry == '..') }
  dirs.map!{|entry| "#{d}/#{entry}" }
  dirs.sort!
  dirs
end

def run(command)
  start = Time.new
  puts ''
  puts "[command] #{command}"
  puts ''
  `#{command}`
  delta = Time.new - start
  puts ''
  puts "--- (Took #{delta}s) ------------------------------------------"
  puts ''
end

##################### GO!

# Make the innodb backup
run("#{BIN} --defaults-file=#{CONF} --ibbackup=#{XTRABACKUP} --user=#{USERNAME} --password=#{PASSWORD} --slave-info #{DESTINATION}")

# Find the latest entry
this_backup = list_dirs(DESTINATION).last

# apply any transient logs (do it 2x, just in case of write drift)
2.times do
  run("#{BIN} --ibbackup=#{XTRABACKUP} --apply-log --use-memory=#{MEMORY} #{this_backup}")
end

# Only keep 10 backups
while list_dirs(DESTINATION).count > BACKUP_COUNT
  dir = list_dirs(DESTINATION).first
  run("rm -rf #{dir}")
end

Process.exit
